<!DOCTYPE html>
<html lang="pt-BR" ng-app="meuApp" id="app">

<head>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="style.css">
  <link rel="shortcut icon" href="/assets/icons/Vector.svg" type="image/x-icon">

  <title>Lista de Compras</title>

  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.0/angular.min.js"></script>
  <script>
    angular.module('meuApp', [])
      .controller('MeuController', function ($scope, $http) {
        $scope.listaCompras = [];
        $scope.ErroInclusao = '';

        $scope.carregarCompras = function () {
          $http(
            {
              url: 'compras.json',
              method: 'GET'
            }).then(function (response) {
              $scope.listaCompras = response.data;
            })
        }

        $scope.carregarCompras();

        $scope.adicionarCompra = function () {
          $scope.ErroInclusao = '';
          // Campos obrigatórios
          var item = $scope.frmCompras.item;
          var quantia = $scope.frmCompras.quantia;

          // Valida se a quantidade é um número inteiro
          if (quantia < 1) {
            $scope.ErroInclusao = 'A quantitidade precisa ser no mínimo 1.';
            return;
          }
          // Verifica se todos os campos estão preenchidos
          if (!item || !quantia) {
            $scope.ErroInclusao = 'Por favor, preencha todos os campos obrigatórios.';
            return;
          }

          // Se passou por todas as validações, prossegue com o cadastro
          $scope.listaCompras.push({
            "item": item,
            "quantia": quantia
          });

          // Envia os dados para o servidor
          $http({
            url: '/addCompras',
            method: 'POST',
            data: {
              "item": item,
              "quantia": quantia
            }
          }).then(function (response) {
            console.log(response.data); // Mensagem de sucesso
          }).catch(function (error) {
            $scope.ErroInclusao = 'Erro ao adicionar a compra: ' + error.message;
          });

          // Limpa o formulário após adicionar
          $scope.frmCompras = {
            "item": "",
            "quantia": ""
          };
        };

        $scope.mostrarModalConfirmacao = false;
        $scope.itemParaExcluir = null;

        // Função para abrir o modal e definir o item a ser excluído
        $scope.excluirCompra = function (item) {
          $scope.itemParaExcluir = item;
          $scope.mostrarModalConfirmacao = true; // Mostra o modal
        };

        // Função chamada quando o usuário confirma a exclusão
        $scope.confirmarExclusao = function () {
          $http({
            url: '/deleteCompra',
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            data: { item: $scope.itemParaExcluir }
          }).then(function (response) {
            $scope.carregarCompras();  // Atualiza a lista após exclusão

            // Exibe o aviso de exclusão
            $scope.exclusaoAviso = true;

            // Oculta o modal
            $scope.mostrarModalConfirmacao = false;
            $scope.itemParaExcluir = null;

            // Após 3 segundos, ocultar a div novamente
            setTimeout(function () {
              $scope.$apply(function () {
                $scope.exclusaoAviso = false;
              });
            }, 3000);

          }).catch(function (error) {
            $scope.ErroExclusao = error.data || 'Erro ao excluir a compra.';
            alert($scope.ErroExclusao);
          });
        };

        // Função chamada quando o usuário cancela a exclusão
        $scope.cancelarExclusao = function () {
          $scope.mostrarModalConfirmacao = false; // Oculta o modal
          $scope.itemParaExcluir = null;
        };



      });
  </script>

</head>

<body ng-controller="MeuController">
  <header>
    <a>
      <img src="/assets/icons/logo.svg" alt="logo">
    </a>
  </header>

  <div id="app">
    <div class="container">
      <a href="#">&lt;- Voltar</a>
    </div>
    <main>
      <form action="" method="post" enctype="multipart/form-data">
        <h1>Compras da semana</h1>
        <div class="input-wrapper">
          <input type="text" placeholder="Adicione um novo item" id="item" ng-model="frmCompras.item">
          <input class="number" type="number" placeholder="Quantidade" id="quantia" ng-model="frmCompras.quantia">
          <button type="button" ng-click="adicionarCompra()">Adicionar item</button>
        </div>

        <div role="list">
          <div role="listbox" ng-repeat="compra in listaCompras">
            <input type="checkbox" name="" id="">
            <span>{{compra.item}}</span>
            <span>{{"Quantidade "+compra.quantia}}</span>
            <button type="button" ng-click="excluirCompra(compra.item)">
              <img src="./assets/icons/delete-02-stroke-rounded.svg" alt="lixeira">
            </button>
          </div>

        </div>
      </form>

      <div class="warning" ng-show="exclusaoAviso">
        <div class="text-container">
          <img src="./assets/icons/warning-circle.svg" alt="">
          <p>O item foi removido da lista</p>
        </div>
        <button type="button" ng-click="exclusaoAviso = false">
          <img src="/assets/icons/cancel-02.svg" alt="">
        </button>
      </div>
      <div class="error-message" ng-show="ErroInclusao">{{ErroInclusao}}</div>
    </main>
  </div>

  <!-- Modal de confirmação -->
  <div class="modal" ng-show="mostrarModalConfirmacao">
    <div class="modal-content">
      <h2>Confirmação de exclusão</h2>
      
      <p>Você tem certeza que deseja excluir o item "{{ itemParaExcluir }}"?</p>
      <button ng-click="confirmarExclusao()">Sim</button>
      <button ng-click="cancelarExclusao()">Cancelar</button>
    </div>
  </div>

</body>

</html>